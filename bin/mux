#!/usr/bin/env bash
# Thanks to ThePrimeagen, source:
# https://github.com/awesome-streamers/awesome-streamerrc/blob/33ff4dfbb624d01dae36891b9a57334dbf0426b2/ThePrimeagen/tmux

SHOPIFY_ROOT="~/world"
STOREFRONT="$SHOPIFY_ROOT/trees/root/src/areas/core/storefront"

DEREK_ROOT="~/src/github.com/derekstride"

createWindow() {
    session=$1
    window=$2
    shift
    shift
    hasWindow=$(tmux list-windows -t $session | grep "$window")

    if [ -z "$hasWindow" ]; then
        cmd="tmux neww -t $session: -n $window -d"
        if [ $# -gt 0 ]; then
            cmd="$cmd $@"
        fi
        echo "Creating Window(\"$hasWindow\"): $cmd"
        eval $cmd
    fi
}

createSession() {
    session=$1
    window=$2
    shift
    shift
    hasSession=$(tmux ls -F "#{session_name}" 2> /dev/null | grep "$session")

    if [ -z "$hasSession" ]; then
      cmd="tmux new -s $session -d -n $window $@ > /dev/null 2>&1"

      echo "Creating Session: $cmd"
      eval $cmd
    fi
}

isWork() {
  if [ -z "$WORK" ]; then
    echo "\$WORK env var not set."
    return 1
  fi
  return 0
}

sayHelp() {
  cat <<- "HELP"
Usage: mux [options]
  options:
  run
  new [WINDOW_NAME]    Create a new tmux window (optionally with specified name)
  split                Split window into 3 panes (left half, right top, right bottom)
  help | --help | -h

  # Project specific
  --dot

  # Work specific
  --sfr
HELP
}

if [ "$1" == "run" ]; then
  shift
  mux-run $@
  exit $?
fi

if [ "$1" == "new" ]; then
  shift
  windowName=${1:-""}

  if [ -n "$windowName" ]; then
    tmux new-window -n "$windowName" -d
    exit $?
  fi

  if ! command -v fzf >/dev/null 2>&1; then
    echo "Error: fzf is required for branch selection" >&2
    exit 1
  fi

  if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: Not inside a git repository" >&2
    exit 1
  fi

  branches=$(git branch --sort=-committerdate --format='%(refname:short)' 2>/dev/null | sed 's/^\* //')

  if [ -z "$branches" ]; then
    echo "No branches available" >&2
    exit 1
  fi

  selection=$(echo "$branches" | fzf --multi --prompt="tmux window branches > " --height=40% --reverse --header="Select branches for new tmux windows")

  if [ -z "$selection" ]; then
    echo "No branches selected" >&2
    exit 1
  fi

  existing_windows=$(tmux list-windows -F '#W' 2>/dev/null)

  while IFS= read -r branch; do
    [ -z "$branch" ] && continue

    if printf '%s\n' "$existing_windows" | grep -Fx -- "$branch" >/dev/null 2>&1; then
      echo "Window '$branch' already exists, skipping" >&2
      continue
    fi

    tmux new-window -n "$branch" -d
  done <<< "$selection"

  exit 0
fi

if [ "$1" == "split" ]; then
  # Split window into 3 panes: left half, right top, right bottom
  # First split horizontally (left and right halves)
  tmux split-window -h -t 0 -l "50%" -d
  # Then split the right pane vertically (top and bottom)
  tmux split-window -v -t 1 -l "50%" -d
  exit $?
fi

if [ "$1" == "help" ]; then
  sayHelp
  exit $?
fi

if [ "$#" -eq 0 ]; then
  sayHelp
  exit 1
fi

while [ "$#" -gt 0 ]; do
    curr=$1
    shift

    case "$curr" in
    "--help" | "-h")
        sayHelp
        ;;
    "--sfr")
        isWork || continue
        createSession sfr primary -c $STOREFRONT
        ;;
    "--dot")
        createSession main-terminal primary
        createWindow main-terminal dot -c $ZSH
        [ -n "$NOTES" ] && createWindow main-terminal notes -c $NOTES
        [ -n "$ZK_PATH" ] && createWindow main-terminal zettel -c $ZK_PATH
        createWindow main-terminal site -c $PROJECTS/github.com/derekstride/derekstride.github.io
        ;;
    *) echo "Unavailable command... $curr"
    esac
done
