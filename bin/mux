#!/usr/bin/env bash
# Thanks to ThePrimeagen, source:
# https://github.com/awesome-streamers/awesome-streamerrc/blob/33ff4dfbb624d01dae36891b9a57334dbf0426b2/ThePrimeagen/tmux

SHOPIFY_ROOT="~/src/github.com/Shopify"
STOREFRONT="$SHOPIFY_ROOT/storefront-renderer"
SHOPIFY="$SHOPIFY_ROOT/shopify"
NGINX="$SHOPIFY_ROOT/nginx-routing-modules"
LIQUID_WASM="$SHOPIFY_ROOT/liquid-wasm"
BACKFILTER="$SHOPIFY_ROOT/backfilter"

DEREK_ROOT="~/src/github.com/derekstride"

createWindow() {
    session=$1
    window=$2
    shift
    shift
    hasWindow=$(tmux list-windows -t $session | grep "$window")

    if [ -z "$hasWindow" ]; then
        cmd="tmux neww -t $session: -n $window -d"
        if [ $# -gt 0 ]; then
            cmd="$cmd $@"
        fi
        echo "Creating Window(\"$hasWindow\"): $cmd"
        eval $cmd
    fi
}

createSession() {
    session=$1
    window=$2
    shift
    shift
    hasSession=$(tmux ls -F "#{session_name}" 2> /dev/null | grep "$session")

    if [ -z "$hasSession" ]; then
      cmd="tmux new -s $session -d -n $window $@ > /dev/null 2>&1"

      echo "Creating Session: $cmd"
      eval $cmd
    fi
}

isWork() {
  if [ -z "$WORK" ]; then
    echo "\$WORK env var not set."
    return 1
  fi
  return 0
}

if [ "$1" == "run" ]; then
  shift
  mux-run $@
  exit $?
fi

while [ "$#" -gt 0 ]; do
    curr=$1
    shift

    case "$curr" in
    "split")
        tmuxVerMajor=$(tmux -V | sed "s/tmux \(.\).*/\1/g")
        tmuxVerMinor=$(tmux -V | sed "s/tmux .\.\(.\).*/\1/g")
        if [ $tmuxVerMajor -lt 3 -o $tmuxVerMinor -lt 1 ]; then
          # Prior to tmux version 3.1 the -p flag was used for denoting the size as a percentage.
          # split-window [-l size | -p percentage]
          tmux split-window -h -t 0 -p 33 -d
        else
          # tmux version 3.1 merged the -p flag into the -l flag
          # split-window [-l size]
          #   size may be followed by `%' to specify a percentage of the available space.
          tmux split-window -h -t 0 -l "33%" -d
        fi
        ;;
    "--sfr")
        isWork || continue
        createSession sfr primary -c $STOREFRONT
        createWindow sfr gql -c $STOREFRONT
        ;;
    "--shopify")
        isWork || continue
        createSession shopify primary -c $SHOPIFY
        ;;
    "--nginx")
        isWork || continue
        createSession nginx primary -c $NGINX
        ;;
    "--liquid")
        isWork || continue
        createSession liquid wasm -c $LIQUID_WASM
        createWindow liquid liquid -c "$SHOPIFY_ROOT/liquid"
        createWindow liquid spec -c "$SHOPIFY_ROOT/liquid-spec"
        createWindow liquid spec-generator -c "$SHOPIFY_ROOT/liquid-spec-generator"
        ;;
    "--shaping")
        isWork || continue
        createSession db-shaping maxwell -c "$SHOPIFY_ROOT/sfr-maxwell-producer"
        createWindow db-shaping sfr -c $STOREFRONT
        createWindow db-shaping backfilter -c $BACKFILTER
        ;;
    "--backfilter")
        isWork || continue
        createSession db-agility backfilter -c $BACKFILTER
        ;;
    "--dot")
        createSession main-alacritty primary
        createWindow main-alacritty dot -c $ZSH
        [ -n "$NOTES" ] && createWindow main-alacritty notes -c $NOTES
        [ -n "$ZK_PATH" ] && createWindow main-alacritty zettel -c $ZK_PATH
        ;;
    "--site")
        createWindow main-alacritty site -c $PROJECTS/github.com/derekstride/derekstride.github.io
        ;;
    "--stride")
        createSession stride-host primary -c $DEREK_ROOT/stride-host
        createWindow stride-host mc -c $DEREK_ROOT/stride-host/images/minecraft
        createWindow stride-host fn -c $DEREK_ROOT/stride-host/functions
        ;;
    *) echo "Unavailable command... $curr"
    esac
done

